# Go P2P Discovery Server

一个基于Go语言的P2P节点发现服务器，提供安全、高效的P2P通信节点发现和连接协调功能。

## 特性

- 🔒 **安全性增强**：客户端名称验证、连接频率限制、消息大小验证
- ⚡ **性能优化**：地址映射优化、批量清理、原子操作统计
- 📊 **实时监控**：服务器统计信息、连接状态跟踪、定期报告
- 🛡️ **错误处理**：详细错误信息、优雅降级、连接重试
- 🎯 **交互式客户端**：命令自动补全、彩色输出、实时通信
- 🔧 **易于部署**：单文件部署、配置文件支持、优雅关闭

## 项目架构

项目采用了以下设计模式和架构原则：

### 设计模式

- **接口与抽象工厂模式**：通过接口定义组件行为，使用工厂创建具体实现，实现组件解耦
- **观察者模式**：用于处理消息通知和事件分发
- **策略模式**：处理不同类型的消息和命令
- **单例模式**：确保全局组件只有一个实例
- **命令模式**：封装客户端命令操作

### 安全设计

- **输入验证**：严格的客户端名称验证（长度、字符限制）
- **频率限制**：防止恶意客户端频繁连接攻击
- **消息验证**：消息大小限制和格式验证
- **状态跟踪**：详细的连接状态和统计信息

### 项目结构

```
├── cmd/                    # 命令行入口
│   ├── client/            # 客户端命令
│   └── server/            # 服务器命令
├── internal/              # 内部包
│   ├── config/            # 配置管理
│   ├── log/               # 日志工具
│   ├── message/           # 消息定义
│   ├── network/           # 网络通信
│   │   ├── connection/    # 连接管理
│   │   ├── protocol/      # 协议实现
│   │   └── transport/     # 传输层
│   ├── peer/              # 对等节点管理
│   └── utils/             # 工具函数
├── pkg/                   # 可导出的包
│   ├── discovery/         # 节点发现
│   └── nat/               # NAT穿透
└── ui/                    # 用户界面
    └── terminal/          # 终端界面
```

## 核心组件

### 发现服务器 (Discovery Server)

- **客户端管理**：维护活跃客户端列表和连接状态
- **消息路由**：处理心跳、连接请求、节点搜索等消息
- **统计监控**：实时统计连接数、消息数、运行时间等指标
- **安全防护**：连接频率限制、输入验证、消息大小控制

### 客户端 (Client)

- **交互式终端**：支持命令自动补全和彩色输出
- **实时通信**：心跳保持、节点发现、P2P连接建立
- **命令系统**：内置help、list、connect、exit等命令
- **状态管理**：连接状态跟踪和自动重连

### 消息系统

- **类型化消息**：心跳、连接、搜索、允许/拒绝等消息类型
- **序列化**：JSON格式消息序列化和反序列化
- **错误处理**：消息验证和错误恢复机制

### 网络通信

- **UDP协议**：高效的UDP通信协议
- **并发处理**：多协程处理消息接收和发送
- **超时控制**：网络操作超时和重试机制

## 快速开始

### 1. 编译项目

```bash
# 编译服务器
go build -o server.exe ./cmd/server

# 编译客户端
go build -o client.exe ./cmd/client
```

### 2. 配置文件

创建 `config.json` 文件：

```json
{
  "server": {
    "port": 8000
  },
  "client": {
    "name": "your-client-name",
    "server_address": "127.0.0.1:8000"
  }
}
```

### 3. 启动服务器

```bash
./server.exe
```

服务器将显示启动信息和统计数据：
```
[Server] P2P Discovery Server started successfully on port 8000
[Server] Server Stats - Uptime: 5m0s, Active Clients: 3, Total Connections: 15, Total Messages: 1247
```

### 4. 启动客户端

```bash
./client.exe
```

客户端将进入交互模式：
```
your-client-name> help
Available commands:
  help     - Show this help message
  list     - List all connected peers
  connect  - Connect to a peer
  exit     - Exit the application

your-client-name> list
Connected peers:
- user1 (192.168.1.100:12345)
- user2 (192.168.1.101:12346)

your-client-name> connect user1
Connecting to user1...
Connection established with user1
```

## 客户端命令

| 命令 | 描述 | 示例 |
|------|------|------|
| `help` | 显示帮助信息 | `help` |
| `list` | 列出所有连接的节点 | `list` |
| `connect <name>` | 连接到指定节点 | `connect user1` |
| `exit` | 退出应用程序 | `exit` |

## 服务器监控

服务器提供以下监控功能：

- **实时统计**：每5分钟输出运行统计信息
- **连接跟踪**：记录每个客户端的连接时间和消息数
- **安全日志**：记录连接频率限制和验证失败
- **优雅关闭**：关闭时输出最终统计信息

## 安全特性

### 客户端验证
- 名称长度限制（最大32字符）
- 字符类型限制（仅允许字母、数字、下划线、连字符）
- 重复名称检测和拒绝

### 连接保护
- 连接频率限制（每个IP 5秒间隔）
- 消息大小限制（最大4096字节）
- 自连接防护

### 监控和日志
- 详细的连接和错误日志
- 实时统计信息输出
- 异常行为检测和记录

## 性能优化

- **O(1)心跳处理**：使用地址映射优化心跳消息处理
- **批量清理**：定期批量清理过期客户端
- **原子操作**：使用原子操作更新统计计数器
- **内存管理**：定期清理过期的连接限制记录

## 故障排除

### 常见问题

1. **客户端无法连接服务器**
   - 检查服务器是否正在运行
   - 验证配置文件中的服务器地址和端口
   - 检查防火墙设置

2. **客户端名称被拒绝**
   - 确保名称长度不超过32字符
   - 只使用字母、数字、下划线和连字符
   - 避免使用已被占用的名称

3. **连接频率限制**
   - 等待5秒后重试连接
   - 避免频繁重启客户端

### 日志级别

服务器和客户端都支持不同的日志级别：
- `INFO`：一般信息（默认）
- `WARN`：警告信息
- `ERROR`：错误信息

## 开发和贡献

### 项目结构说明

- `cmd/`：可执行程序入口
- `internal/`：内部包，不对外暴露
- `pkg/`：可重用的包
- `ui/`：用户界面相关代码

### 编译要求

- Go 1.19 或更高版本
- 支持 Windows、Linux、macOS

## 许可证

本项目采用MIT许可证。详见LICENSE文件。
